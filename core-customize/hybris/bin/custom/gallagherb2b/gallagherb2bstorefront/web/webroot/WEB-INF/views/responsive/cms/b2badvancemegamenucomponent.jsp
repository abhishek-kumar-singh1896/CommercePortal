<%@ page trimDirectiveWhitespaces="true"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="cms" uri="http://hybris.com/tld/cmstags"%>
<%@ taglib prefix="sec"
	uri="http://www.springframework.org/security/tags"%>

<c:if test="${component.visible}">
	<nav
		class="navigation navigation--bottom js_navigation--bottom js-enquire-offcanvas-navigation"
		role="navigation">
		<ul
			class="sticky-nav-top hidden-lg hidden-md js-sticky-user-group hidden-md hidden-lg">
			<%--Dynamically generated by 'acc.navigation.js"--%>
		</ul>
		<div class="navigation__overflow">
			<ul data-trigger="#signedInUserOptionsToggle"
				class="nav__links nav__links--products nav__links--mobile js-userAccount-Links js-nav-collapse-body offcanvasGroup1 collapse in hidden-md hidden-lg">
				<%--Dynamically generated by 'acc.navigation.js"--%>
			</ul>
			<ul class="nav__links nav__links--products js-offcanvas-links">
				<c:forEach items="${menuItems}" var="menuItem">
					<c:set var="menuData" value="${menuMap[menuItem.categoryCode]}" />
					<li
						class="auto nav__links--primary <c:if test="${not empty menuData.subCategories[menuItem.categoryCode]}">nav__links--primary-has__sub js-enquire-has-sub</c:if>">
						<c:choose>
							<c:when test="${menuItem.isBulkOrder eq 'true'}">
								<%--<sec:authorize access="hasAnyRole('ROLE_DISTRIBUTOR')">--%>
									<c:url value="/bulkOrderFormPage" var="bulkOrderPageUrl" />
									<a class="visible-xs visible-sm" href="${bulkOrderPageUrl}">${menuItem.link.linkName}</a>

									<span
										class="hidden-xs hidden-sm primary-level nav__link bulkOrderNavLink">
										<cms:component component="${menuItem.link}"
											evaluateRestriction="true" />
									</span>

									<div
										class="bulkOrderNavDiv hidden-xs hidden-sm toBeRemovedOnMobile js_sub__navigation col-md-3 col-lg-2"
										style="display: none;">
										<cms:component uid="HomePageBulkOrderComponent" />
									</div>
								<%--</sec:authorize>--%>
							</c:when>
							<c:otherwise>
								<span class="primary-level nav__link js_nav__link"> <cms:component
										component="${menuItem.link}" evaluateRestriction="true"
										class="nav__link js_nav__link" />
								</span>
							</c:otherwise>
						</c:choose> <%-- Calculate how many sub columns are needed -- Start --%> <c:set
							var="totalSubNavigationColumns" value="${0}" /> <c:set
							var="hasSubChild" value="false" /> <%-- <c:forEach items="${menuData.subCategories[menuItem.categoryCode]}" var="child"> 
							<c:if test="${not empty menuData.subCategories[child.code]}">
								<c:set var="hasSubChild" value="true"/>
								<c:set var="subSectionColumns" value="${fn:length(menuData.subCategories[child.code])/menuItem.wrapAfter}"/>
								<c:if test="${subSectionColumns > 1 && fn:length(menuData.subCategories[child.code])%menuItem.wrapAfter > 0}">
									<c:set var="subSectionColumns" value="${subSectionColumns + 1}"/>
								</c:if>
								<c:choose>
									<c:when test="${subSectionColumns > 1}">
										<c:set var="totalSubNavigationColumns" value="${totalSubNavigationColumns + subSectionColumns}" />
									</c:when>
			
									<c:when test="${subSectionColumns < 1}">
										<c:set var="totalSubNavigationColumns" value="${totalSubNavigationColumns + 1}" />
									</c:when>
								</c:choose>
							</c:if>
						</c:forEach> --%> <%-- Calculate how many sub columns are needed -- End --%>

						<%-- Decide which class to use -- Start --%> <%-- <c:choose>
							<c:when test="${!hasSubChild || (totalSubNavigationColumns > 0 && totalSubNavigationColumns <= 1)}">
								<c:set value="col-md-3 col-lg-2" var="subNavigationClass"/>
								<c:set value="col-md-12" var="subNavigationItemClass"/>
							</c:when>
		
							<c:when test="${totalSubNavigationColumns == 2}">
								<c:set value="col-md-6 col-lg-4" var="subNavigationClass"/>
								<c:set value="col-md-6" var="subNavigationItemClass"/>
							</c:when>
							
							<c:when test="${totalSubNavigationColumns == 3}">
								<c:set value="col-md-9 col-lg-6" var="subNavigationClass"/>
								<c:set value="col-md-4" var="subNavigationItemClass"/>
							</c:when>
		
							<c:when test="${totalSubNavigationColumns == 4}">
								<c:set value="col-md-12 col-lg-8" var="subNavigationClass"/>
								<c:set value="col-md-3" var="subNavigationItemClass"/>
							</c:when>
		
							<c:when test="${totalSubNavigationColumns == 5}">
								<c:set value="col-md-12" var="subNavigationClass"/>
								custom grid class required because 1/5th columns aren't supported by bootstrap
								<c:set value="column-20-percent" var="subNavigationItemClass"/>
							</c:when>
		
							<c:when test="${totalSubNavigationColumns > 5}">
								<c:set value="col-md-12" var="subNavigationClass"/>
								<c:set value="col-md-2" var="subNavigationItemClass"/>
							</c:when>
						</c:choose> --%> <%-- Decide which class to use -- End --%> <c:if
							test="${not empty menuData.subCategories[menuItem.categoryCode]}">
							<span
								class="glyphicon  glyphicon-chevron-right hidden-md hidden-lg nav__link--drill__down js_nav__link--drill__down"></span>
							<div class="sub__navigation js_sub__navigation col-md-3 col-lg-2">
								<a class="sm-back js-enquire-sub-close hidden-md hidden-lg"
									href="#">Back</a>


								<c:choose>
									<c:when test="${ menuItem.isAllProductsNode eq 'true'}">



										<div class="row">
											<c:forEach
												items="${menuData.subCategories[menuItem.categoryCode]}"
												var="allProductsChilds">
												<div
													class="sub-navigation-section ${subNavigationItemClass}">
													<c:if
														test="${not empty menuData.subCategories[allProductsChilds.code]}">
														<c:forEach
															items="${menuData.subCategories[allProductsChilds.code]}"
															step="${menuItem.wrapAfter}" var="allProductsL2Child"
															varStatus="i">
															<%-- for a large amount of links (depending on what wrapAfter is set to) that would exceed 6 columns, insert a clearfix div to have the next row properly aligned --%>
															<c:if
																test="${i.index != 0 && i.index % (6*menuItem.wrapAfter) == 0}">
																<div class="clearfix hidden-sm-down"></div>
															</c:if>

															<%--only add title on first loop for each sub-section--%>
															<c:if
																test="${i.index == 0 && not empty allProductsChilds.name}">
																<div class="title">${allProductsChilds.name}</div>
															</c:if>
															<ul class="sub-navigation-list has-child">
																<c:forEach
																	items="${menuData.subCategories[allProductsChilds.code]}"
																	var="allProductsL2Child" begin="${i.index}"
																	end="${i.index + menuItem.wrapAfter - 1}">


																	<li
																		class="verticalMenuOption  groupOfLinks
																				<c:if test="${not empty menuData.subCategories[allProductsL2Child.code] and allProductsL2Child.thirdLevelNode }">hasNextLevel</c:if> ">
																		<c:url value="${allProductsL2Child.url}"
																			var="allProductsL2ChildUrl" /> <span
																		class="second-level nav__link js_nav__link"> <a
																			href="${allProductsL2ChildUrl}"
																			title="${allProductsL2Child.name}">
																				${allProductsL2Child.name}</a></span> <c:if
																			test="${not empty menuData.subCategories[allProductsL2Child.code] and allProductsL2Child.thirdLevelNode }">
																			<span
																				class="glyphicon  glyphicon-chevron-right hidden-md hidden-lg nav__link--drill__down js_nav__link--drill__down"></span>
																			<div class="horizontalMenu sectionUp">

																				<a
																					class="sm-back js-enquire-sub-close-second-level hidden-md hidden-lg"
																					href="#">Back</a>
																				<div class="title">${allProductsL2Child.name}</div>
																				<ul class="column1">
																					<c:forEach
																						items="${menuData.subCategories[allProductsL2Child.code]}"
																						var="allProductsL3Child" varStatus="count">


																						<li><c:url value="${allProductsL3Child.url}"
																								var="allProductsL3ChildUrl" /> <a
																							href="${allProductsL3ChildUrl}"
																							title="${allProductsL3Child.name}">${allProductsL3Child.name}
																								<c:choose>
																									<c:when
																										test="${empty allProductsL3Child.productCount}">
																					(0)
																				</c:when>
																									<c:otherwise>
																					(${allProductsL3Child.productCount})	
																			</c:otherwise>
																								</c:choose>
																						</a></li>
																					</c:forEach>
																				</ul>

																			</div>
																		</c:if>
																	</li>



																</c:forEach>
															</ul>

														</c:forEach>
													</c:if>

													<c:if
														test="${empty menuData.subCategories[allProductsChilds.code]}">

														<ul class="sub-navigation-list no-child">
															<li class="verticalMenuOption groupOfLinks"><c:url
																	value="${allProductsChilds.url}" var="childUrl" /> <a
																href="${childUrl}" title="${allProductsChilds.name}">${allProductsChilds.name}</a>
															</li>
														</ul>
													</c:if>
												</div>
											</c:forEach>
										</div>

									</c:when>
									<c:otherwise>
										<div class="row">
											<c:forEach
												items="${menuData.subCategories[menuItem.categoryCode]}"
												var="child">
												<div
													class="sub-navigation-section ${subNavigationItemClass}">
													<c:if
														test="${not empty menuData.subCategories[child.code]}">
														<c:forEach items="${menuData.subCategories[child.code]}"
															step="${menuItem.wrapAfter}" var="childlink"
															varStatus="i">
															<%-- for a large amount of links (depending on what wrapAfter is set to) that would exceed 6 columns, insert a clearfix div to have the next row properly aligned --%>
															<c:if
																test="${i.index != 0 && i.index % (6*menuItem.wrapAfter) == 0}">
																<div class="clearfix hidden-sm-down"></div>
															</c:if>

															<%--only add title on first loop for each sub-section--%>
															<c:if test="${i.index == 0 && not empty child.name}">
																<div class="title">${child.name}</div>
															</c:if>
															<ul class="sub-navigation-list has-child">
																<c:forEach items="${menuData.subCategories[child.code]}"
																	var="childlink" begin="${i.index}"
																	end="${i.index + menuItem.wrapAfter - 1}">
																	<li class="verticalMenuOption groupOfLinks"><c:url
																			value="${childlink.url}" var="l2ChildUrl" /> <a
																		href="${l2ChildUrl}" title="${childlink.name}">${childlink.name}</a>
																	</li>
																</c:forEach>
															</ul>

														</c:forEach>
													</c:if>

													<c:if test="${empty menuData.subCategories[child.code]}">

														<ul class="sub-navigation-list no-child">
															<li class="verticalMenuOption groupOfLinks"><c:url
																	value="${child.url}" var="childUrl" /> <a
																href="${childUrl}" title="${child.name}">${child.name}</a>
															</li>
														</ul>
													</c:if>
												</div>
											</c:forEach>
										</div>

									</c:otherwise>
								</c:choose>
							</div>
						</c:if>
					</li>
				</c:forEach>
			</ul>
		</div>
	</nav>
</c:if>