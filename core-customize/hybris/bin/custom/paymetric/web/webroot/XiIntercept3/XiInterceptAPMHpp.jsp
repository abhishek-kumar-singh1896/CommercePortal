<%@ page trimDirectiveWhitespaces="true" %>
<%@page import="com.paymetric.sdk.AccessTokenUtility"%>
<%@page import="com.paymetric.sdk.models.AccessTokenResponse.AccessTokenResponsePacket"%>
<%@page import="com.paymetric.sdk.models.APMPacket.APMPacket"%>
<%@page import="com.paymetric.sdk.XIConfig"%>
<%@page import="java.io.DataOutputStream"%>
<%
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Forward-Declare global variables
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
String xmlPacket = null;
String strError = null;
XIConfig xiConfig = null;
APMPacket packetRQ = null;
AccessTokenResponsePacket packetRS = null;

try
{
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	// Load the XiIntercept configuration file
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	xiConfig = new XIConfig();
	xiConfig.Config(request, "XiIntercept.properties");

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	// Initialize the APM packet for XiIntercept
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	packetRQ = xiConfig.getApmPacketHpp(request);
	xmlPacket = AccessTokenUtility.marshal(packetRQ);


	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	// Get an Access Token for this request
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	packetRS = AccessTokenUtility.GetAPMAccessToken(XIConfig.CC_GUID.get(), XIConfig.CC_PSK.get(), XIConfig.URL.get(), xmlPacket);
	if(packetRS != null)
	{
		xmlPacket = AccessTokenUtility.marshal(packetRS);
	}
	else
	{
		xmlPacket = "<Error/>";
	}
	xmlPacket = "<?xml version=\"1.0\"?>\n" + xmlPacket;
	response.setContentType("application/xml");
	response.setHeader("Content-Disposition", "inline");
	response.getOutputStream().write(xmlPacket.getBytes("UTF-8"));
}
catch(Exception ex)
{
	ex.printStackTrace();
}

%>
